name: ðŸ¥ Health Check

on:
  schedule:
    # ÐšÐ°Ð¶Ð´Ñ‹Ðµ 30 Ð¼Ð¸Ð½ÑƒÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
        - development

env:
  NODE_VERSION: '20.x'

jobs:
  health-check:
    name: ðŸ¥ System Health Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: 
          - name: 'Production'
            url: 'http://localhost:8080/engine-rest'
            username: 'demo'
            password: 'demo'
          - name: 'Test Environment'
            url: 'http://localhost:8080/engine-rest'
            username: 'demo'
            password: 'demo'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build project
        run: npm run build

      - name: ðŸ¥ Check Camunda Engine Health
        id: camunda-health
        run: |
          echo "ðŸ” Checking Camunda Engine: ${{ matrix.environment.name }}"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ engine
          ENGINE_RESPONSE=$(curl -s -w "%{http_code}" \
            -u "${{ matrix.environment.username }}:${{ matrix.environment.password }}" \
            "${{ matrix.environment.url }}/engine" || echo "000")
          
          ENGINE_STATUS="${ENGINE_RESPONSE: -3}"
          
          if [ "$ENGINE_STATUS" = "200" ]; then
            echo "âœ… Camunda Engine is healthy"
            echo "engine_healthy=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Camunda Engine is unhealthy (HTTP $ENGINE_STATUS)"
            echo "engine_healthy=false" >> $GITHUB_OUTPUT
            echo "engine_status=$ENGINE_STATUS" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ§ª Test MCP Server Basic Functions
        if: steps.camunda-health.outputs.engine_healthy == 'true'
        run: |
          echo "ðŸ§ª Testing MCP Server basic functions"
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ MCP ÑÐµÑ€Ð²ÐµÑ€ Ð² Ñ„Ð¾Ð½Ðµ
          export CAMUNDA_BASE_URL="${{ matrix.environment.url }}"
          export CAMUNDA_USERNAME="${{ matrix.environment.username }}"
          export CAMUNDA_PASSWORD="${{ matrix.environment.password }}"
          
          timeout 30s node build/index.js > mcp_output.log 2>&1 &
          MCP_PID=$!
          
          # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°
          sleep 3
          
          # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
          echo '{"jsonrpc": "2.0", "id": 1, "method": "tools/list"}' | \
            timeout 10s node build/index.js > tools_list.json 2>&1 || true
          
          # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²
          echo '{"jsonrpc": "2.0", "id": 2, "method": "tools/call", "params": {"name": "getProcessDefinitions", "arguments": {"maxResults": 1}}}' | \
            timeout 10s node build/index.js > process_defs.json 2>&1 || true
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
          if grep -q "tools" tools_list.json; then
            echo "âœ… MCP tools list working"
          else
            echo "âŒ MCP tools list failed"
            cat tools_list.json
          fi
          
          if grep -q "content" process_defs.json; then
            echo "âœ… MCP process definitions working"
          else
            echo "âŒ MCP process definitions failed"
            cat process_defs.json
          fi
          
          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°
          kill $MCP_PID 2>/dev/null || true

      - name: ðŸ“Š Performance Test
        if: steps.camunda-health.outputs.engine_healthy == 'true'
        run: |
          echo "ðŸ“Š Running performance tests"
          
          export CAMUNDA_BASE_URL="${{ matrix.environment.url }}"
          export CAMUNDA_USERNAME="${{ matrix.environment.username }}"
          export CAMUNDA_PASSWORD="${{ matrix.environment.password }}"
          
          # Ð˜Ð·Ð¼ÐµÑ€ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ñ‚ÐºÐ»Ð¸ÐºÐ° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²
          start_time=$(date +%s%N)
          
          curl -s -u "${{ matrix.environment.username }}:${{ matrix.environment.password }}" \
            "${{ matrix.environment.url }}/process-definition?maxResults=10" \
            > /dev/null
          
          end_time=$(date +%s%N)
          response_time=$(( (end_time - start_time) / 1000000 ))
          
          echo "â±ï¸ Process definitions response time: ${response_time}ms"
          
          if [ $response_time -lt 5000 ]; then
            echo "âœ… Response time is acceptable"
          else
            echo "âš ï¸ Response time is slow (${response_time}ms)"
          fi

      - name: ðŸš¨ Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Health Check Failed - ${{ matrix.environment.name }}`;
            const body = `
            ## ðŸš¨ Health Check Alert
            
            **Environment**: ${{ matrix.environment.name }}
            **Time**: ${new Date().toISOString()}
            **Workflow**: ${{ github.workflow }}
            **Run ID**: ${{ github.run_id }}
            
            ### Issues Detected:
            - Camunda Engine Health: ${{ steps.camunda-health.outputs.engine_healthy == 'true' && 'âœ… Healthy' || 'âŒ Unhealthy' }}
            ${steps.camunda-health.outputs.engine_status ? `- HTTP Status: ${steps.camunda-health.outputs.engine_status}` : ''}
            
            ### Next Steps:
            1. Check Camunda Engine status
            2. Verify network connectivity
            3. Check authentication credentials
            4. Review system resources
            
            **Auto-generated by Health Check workflow**
            `;
            
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check,alert'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes(`Health Check Failed - ${{ matrix.environment.name }}`)
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['health-check', 'alert', 'bug']
              });
            } else {
              // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `ðŸ”„ **Health check failed again**\n\nTime: ${new Date().toISOString()}\nRun ID: ${{ github.run_id }}`
              });
            }

      - name: ðŸ“ˆ Update Status Badge
        if: always()
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð´Ð»Ñ README badge
          STATUS="${{ steps.camunda-health.outputs.engine_healthy == 'true' && 'healthy' || 'unhealthy' }}"
          COLOR="${{ steps.camunda-health.outputs.engine_healthy == 'true' && 'green' || 'red' }}"
          
          echo "Health status: $STATUS"
          echo "Badge color: $COLOR"
          
          # ÐœÐ¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… badges

  # Ð¡ÑƒÐ¼Ð¼Ð°Ñ€Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ Ð²ÑÐµÑ… ÑÑ€ÐµÐ´
  health-summary:
    name: ðŸ“‹ Health Summary
    runs-on: ubuntu-latest
    needs: [health-check]
    if: always()
    steps:
      - name: ðŸ“‹ Generate Health Report
        run: |
          echo "## ðŸ¥ System Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Check Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÑÑ€ÐµÐ´Ñ‹
          echo "### Environment Status:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "âœ… **All Environments**: HEALTHY" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some Environments**: UNHEALTHY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Check individual environment logs for details" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automated health check - runs every 30 minutes*" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”” Notify on Persistent Issues
        if: failure()
        run: |
          echo "ðŸ”” Persistent health issues detected"
          echo "Consider manual intervention or escalation"
